generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  COORDINATOR
  LECTURER
  ADMIN
}

enum DocumentType {
  SLI_01
  SLI_03
  SLI_04
  BLI_01
  BLI_02
  BLI_03
  BLI_03_HARDCOPY
  BLI_04
  DLI_01
  OFFER_LETTER
  STUDY_PLAN
}

enum Decision {
  APPROVE
  REQUEST_CHANGES
  REJECT
}

enum Channel {
  IN_APP
  EMAIL
  WHATSAPP
  SMS
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  CANCELLED
}

enum DocumentStatus {
  DRAFT
  PENDING_SIGNATURE
  SIGNED
  REJECTED
  CANCELLED
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}

model User {
  id            String   @id @default(uuid()) @db.Uuid
  name          String
  email         String   @unique
  password      String
  role          UserRole
  matricNo      String?  @unique
  program       String?
  phone         String?
  creditsEarned Int?

  mfaEnabled Boolean @default(false)
  mfaSecret  String?

  pdpaConsent   Boolean   @default(false)
  pdpaConsentAt DateTime?
  tosAccepted   Boolean   @default(false)
  tosAcceptedAt DateTime?

  ssoProvider String?
  ssoId       String?

  lastLoginAt DateTime?
  isActive    Boolean   @default(true)

  applications        Application[]
  eligibilities       Eligibility[]
  reviews             Review[]         @relation("ReviewReviewer")
  notifications       Notification[]
  auditLogs           AuditLog[]       @relation("AuditLogActor")
  verifiedForms       FormResponse[]   @relation("FormResponseVerifier")
  refreshTokens       RefreshToken[]
  studentSessions     StudentSession[]
  coordinatedSessions Session[]        @relation("SessionCoordinator")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ssoId, ssoProvider])
}

model Eligibility {
  id            String   @id @default(uuid()) @db.Uuid
  user          User     @relation(fields: [userId], references: [id])
  userId        String   @db.Uuid
  creditsEarned Int
  isEligible    Boolean
  checkedOn     DateTime @default(now())
  source        String

  @@index([userId])
}

model Session {
  id            String  @id @default(uuid()) @db.Uuid
  name          String
  year          Int
  semester      Int
  deadlinesJSON Json?
  minCredits    Int     @default(113)
  minWeeks      Int
  maxWeeks      Int
  isActive      Boolean @default(true)

  coordinator   User?   @relation("SessionCoordinator", fields: [coordinatorId], references: [id])
  coordinatorId String? @db.Uuid

  applications    Application[]
  studentSessions StudentSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coordinatorId])
}

model StudentSession {
  id        String  @id @default(uuid()) @db.Uuid
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId String  @db.Uuid
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String  @db.Uuid

  creditsEarned Int
  isEligible    Boolean
  status        String  @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}

model Company {
  id           String  @id @default(uuid()) @db.Uuid
  name         String
  address      String?
  industry     String?
  contactName  String?
  contactEmail String?
  contactPhone String?
  fax          String?

  applications Application[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Application {
  id        String   @id @default(uuid()) @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @db.Uuid
  session   Session  @relation(fields: [sessionId], references: [id])
  sessionId String   @db.Uuid
  company   Company? @relation(fields: [companyId], references: [id])
  companyId String?  @db.Uuid

  status              ApplicationStatus
  startDate           DateTime?
  endDate             DateTime?
  agreedBeyond14Weeks Boolean           @default(false)

  // BLI03 Student Information
  studentPhone String?
  studentEmail String?

  // BLI03 Organization Selection
  organizationName                String?
  organizationAddress             String?
  organizationPhone               String?
  organizationFax                 String?
  organizationEmail               String?
  contactPersonName               String?
  contactPersonPhone              String?
  organizationDeclarationAccepted Boolean @default(false)

  // BLI03 Additional Information
  reportingPeriod       String?
  roleTasksSummary      String?
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactEmail String?

  documents     Document[]
  formResponses FormResponse[]
  reviews       Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([sessionId])
  @@index([companyId])
}

model Document {
  id            String      @id @default(uuid()) @db.Uuid
  application   Application @relation(fields: [applicationId], references: [id])
  applicationId String      @db.Uuid

  type     DocumentType
  fileUrl  String
  version  Int            @default(1)
  signedBy String?
  signedAt DateTime?
  status   DocumentStatus

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([applicationId])
}

model FormResponse {
  id            String      @id @default(uuid()) @db.Uuid
  application   Application @relation(fields: [applicationId], references: [id])
  applicationId String      @db.Uuid

  formTypeEnum String

  payloadJSON Json
  submittedAt DateTime @default(now())

  verifier   User?   @relation("FormResponseVerifier", fields: [verifiedBy], references: [id])
  verifiedBy String? @db.Uuid

  @@index([applicationId])
  @@index([verifiedBy])
}

model Review {
  id            String      @id @default(uuid()) @db.Uuid
  application   Application @relation(fields: [applicationId], references: [id])
  applicationId String      @db.Uuid

  reviewer   User   @relation("ReviewReviewer", fields: [reviewerId], references: [id])
  reviewerId String @db.Uuid

  decision  Decision
  comments  String?
  decidedAt DateTime @default(now())

  @@index([applicationId])
  @@index([reviewerId])
}

model Notification {
  id     String @id @default(uuid()) @db.Uuid
  user   User   @relation(fields: [userId], references: [id])
  userId String @db.Uuid

  type        String
  channel     Channel
  payloadJSON Json
  sentAt      DateTime?
  status      NotificationStatus

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([status])
}

model AuditLog {
  id String @id @default(uuid()) @db.Uuid

  actor   User?   @relation("AuditLogActor", fields: [actorId], references: [id])
  actorId String? @db.Uuid

  action       String
  resourceType String
  resourceId   String
  beforeJSON   Json?
  afterJSON    Json?
  timestamp    DateTime @default(now())

  @@index([actorId])
  @@index([resourceType, resourceId])
}

model RefreshToken {
  id     String @id @default(uuid()) @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.Uuid

  token     String   @unique
  expiresAt DateTime
  isRevoked Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}
